<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CodeMind AI ‚Äî Ultimate Coding Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #030712;
    --surface: #0d1117;
    --surface2: #161b22;
    --border: #21262d;
    --accent: #00ff88;
    --accent2: #00d4ff;
    --accent3: #ff6b35;
    --text: #e6edf3;
    --muted: #7d8590;
    --glow: rgba(0,255,136,0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Syne', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      linear-gradient(rgba(0,255,136,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,255,136,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* Ambient glow blobs */
  .blob1 {
    position: fixed; width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(0,255,136,0.06) 0%, transparent 70%);
    top: -200px; right: -100px; pointer-events: none; z-index: 0;
    animation: float1 8s ease-in-out infinite;
  }
  .blob2 {
    position: fixed; width: 400px; height: 400px;
    background: radial-gradient(circle, rgba(0,212,255,0.05) 0%, transparent 70%);
    bottom: 100px; left: -100px; pointer-events: none; z-index: 0;
    animation: float2 10s ease-in-out infinite;
  }
  @keyframes float1 { 0%,100%{transform:translateY(0)} 50%{transform:translateY(30px)} }
  @keyframes float2 { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-20px)} }

  /* Layout */
  .app {
    position: relative; z-index: 1;
    display: flex; flex-direction: column;
    height: 100vh; max-width: 1400px;
    margin: 0 auto; padding: 0 20px;
  }

  /* Header */
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 18px 0; border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .logo {
    display: flex; align-items: center; gap: 10px;
    font-size: 1.2rem; font-weight: 800; letter-spacing: -0.02em;
  }
  .logo-icon {
    width: 32px; height: 32px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
    box-shadow: 0 0 20px var(--glow);
  }
  .logo span { color: var(--accent); }

  .header-right {
    display: flex; align-items: center; gap: 12px;
  }
  .lang-badge {
    padding: 4px 10px; border-radius: 20px;
    background: var(--surface2); border: 1px solid var(--border);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem; color: var(--accent); cursor: pointer;
    transition: all 0.2s;
  }
  .lang-badge:hover { border-color: var(--accent); box-shadow: 0 0 10px var(--glow); }
  .lang-badge.active { background: var(--glow); border-color: var(--accent); }

  .model-badge {
    display: flex; align-items: center; gap: 6px;
    padding: 6px 12px; border-radius: 20px;
    background: var(--surface2); border: 1px solid var(--border);
    font-size: 0.75rem; color: var(--muted);
  }
  .model-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--accent); animation: pulse 2s infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  /* Main layout */
  .main { display: flex; flex: 1; gap: 0; overflow: hidden; }

  /* Sidebar */
  .sidebar {
    width: 220px; flex-shrink: 0;
    border-right: 1px solid var(--border);
    padding: 20px 16px;
    display: flex; flex-direction: column; gap: 6px;
    overflow-y: auto;
  }
  .sidebar-label {
    font-size: 0.6rem; font-weight: 700; letter-spacing: 0.15em;
    color: var(--muted); text-transform: uppercase;
    padding: 0 8px; margin: 10px 0 4px;
  }
  .sidebar-btn {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 10px; border-radius: 8px;
    background: none; border: none; color: var(--muted);
    font-family: 'Syne', sans-serif; font-size: 0.82rem;
    cursor: pointer; width: 100%; text-align: left;
    transition: all 0.15s;
  }
  .sidebar-btn:hover { background: var(--surface2); color: var(--text); }
  .sidebar-btn.active { background: var(--glow); color: var(--accent); border: 1px solid rgba(0,255,136,0.2); }
  .sidebar-btn .icon { font-size: 14px; width: 16px; text-align: center; }

  .new-chat-btn {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    width: 100%; padding: 10px; border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none; color: #000; font-family: 'Syne', sans-serif;
    font-size: 0.82rem; font-weight: 700; cursor: pointer;
    margin-bottom: 8px; transition: all 0.2s;
    box-shadow: 0 4px 20px var(--glow);
  }
  .new-chat-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 25px var(--glow); }

  /* Chat area */
  .chat-area {
    flex: 1; display: flex; flex-direction: column; overflow: hidden;
  }

  .messages {
    flex: 1; overflow-y: auto; padding: 24px 28px;
    display: flex; flex-direction: column; gap: 20px;
    scrollbar-width: thin; scrollbar-color: var(--border) transparent;
  }
  .messages::-webkit-scrollbar { width: 4px; }
  .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* Welcome screen */
  .welcome {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; height: 100%; gap: 32px;
    text-align: center;
  }
  .welcome-icon {
    width: 72px; height: 72px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 20px; display: flex; align-items: center;
    justify-content: center; font-size: 32px;
    box-shadow: 0 0 40px var(--glow), 0 0 80px rgba(0,212,255,0.1);
    animation: iconFloat 4s ease-in-out infinite;
  }
  @keyframes iconFloat { 0%,100%{transform:translateY(0) rotate(0deg)} 50%{transform:translateY(-8px) rotate(3deg)} }

  .welcome h1 {
    font-size: 2rem; font-weight: 800; letter-spacing: -0.03em;
    line-height: 1.2;
  }
  .welcome h1 span {
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .welcome p { color: var(--muted); font-size: 0.9rem; max-width: 400px; line-height: 1.6; }

  .suggestions {
    display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    width: 100%; max-width: 560px;
  }
  .suggest-card {
    padding: 14px 16px; border-radius: 12px;
    background: var(--surface); border: 1px solid var(--border);
    cursor: pointer; text-align: left; transition: all 0.2s;
    font-family: 'Syne', sans-serif;
  }
  .suggest-card:hover {
    border-color: var(--accent); background: var(--glow);
    transform: translateY(-2px);
  }
  .suggest-card .s-icon { font-size: 18px; margin-bottom: 6px; }
  .suggest-card .s-title { font-size: 0.8rem; font-weight: 600; color: var(--text); }
  .suggest-card .s-sub { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }

  /* Messages */
  .msg { display: flex; gap: 14px; animation: msgIn 0.3s ease; }
  @keyframes msgIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform:translateY(0); } }

  .msg.user { flex-direction: row-reverse; }

  .avatar {
    width: 32px; height: 32px; border-radius: 8px;
    flex-shrink: 0; display: flex; align-items: center;
    justify-content: center; font-size: 14px;
  }
  .avatar.ai {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: #000; font-weight: 700; font-size: 11px;
  }
  .avatar.user { background: var(--surface2); border: 1px solid var(--border); }

  .bubble {
    max-width: 75%; padding: 14px 18px; border-radius: 16px;
    line-height: 1.7; font-size: 0.88rem;
  }
  .msg.ai .bubble {
    background: var(--surface); border: 1px solid var(--border);
    border-bottom-left-radius: 4px;
  }
  .msg.user .bubble {
    background: linear-gradient(135deg, rgba(0,255,136,0.12), rgba(0,212,255,0.08));
    border: 1px solid rgba(0,255,136,0.25);
    border-bottom-right-radius: 4px; color: var(--text);
  }

  /* Code blocks */
  .code-wrap {
    margin: 10px 0; border-radius: 10px; overflow: hidden;
    border: 1px solid var(--border);
  }
  .code-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 14px; background: var(--surface2);
    font-family: 'JetBrains Mono', monospace; font-size: 0.72rem;
    color: var(--muted);
  }
  .code-header .lang-tag { color: var(--accent); }
  .copy-btn {
    background: none; border: 1px solid var(--border); color: var(--muted);
    padding: 3px 10px; border-radius: 6px; font-size: 0.68rem;
    cursor: pointer; transition: all 0.2s; font-family: 'Syne', sans-serif;
  }
  .copy-btn:hover { border-color: var(--accent); color: var(--accent); }
  pre {
    background: #0a0e16; padding: 16px; overflow-x: auto;
    font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
    line-height: 1.7; color: #abb2bf;
  }
  .kw { color: #c678dd; } .fn { color: #61afef; }
  .str { color: #98c379; } .cm { color: #5c6370; font-style: italic; }
  .num { color: #d19a66; } .op { color: #56b6c2; }

  /* Input area */
  .input-area {
    padding: 16px 28px 20px; border-top: 1px solid var(--border);
    flex-shrink: 0;
  }
  .input-wrap {
    display: flex; align-items: flex-end; gap: 10px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 14px; padding: 10px 10px 10px 16px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .input-wrap:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--glow);
  }
  #userInput {
    flex: 1; background: none; border: none; outline: none;
    color: var(--text); font-family: 'Syne', sans-serif;
    font-size: 0.88rem; line-height: 1.6; resize: none;
    max-height: 180px; min-height: 24px;
  }
  #userInput::placeholder { color: var(--muted); }
  .input-actions { display: flex; gap: 6px; align-items: flex-end; }
  .action-btn {
    width: 34px; height: 34px; border-radius: 8px;
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--muted); cursor: pointer; font-size: 14px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
  }
  .action-btn:hover { border-color: var(--accent); color: var(--accent); }
  #sendBtn {
    width: 34px; height: 34px; border-radius: 8px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none; color: #000; cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; box-shadow: 0 2px 12px var(--glow);
  }
  #sendBtn:hover { transform: scale(1.05); box-shadow: 0 4px 20px var(--glow); }
  #sendBtn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  .input-hint {
    display: flex; align-items: center; justify-content: space-between;
    margin-top: 8px; padding: 0 4px;
    font-size: 0.68rem; color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
  }

  /* Thinking indicator */
  .thinking {
    display: flex; gap: 5px; align-items: center;
    padding: 14px 18px;
  }
  .thinking span {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--accent); animation: think 1.2s infinite;
  }
  .thinking span:nth-child(2) { animation-delay: 0.2s; }
  .thinking span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes think { 0%,100%{transform:scale(0.6);opacity:0.3} 50%{transform:scale(1);opacity:1} }

  /* Right panel */
  .right-panel {
    width: 280px; flex-shrink: 0;
    border-left: 1px solid var(--border);
    padding: 20px 16px;
    display: flex; flex-direction: column; gap: 16px;
    overflow-y: auto;
  }
  .panel-section { }
  .panel-title {
    font-size: 0.65rem; font-weight: 700; letter-spacing: 0.15em;
    color: var(--muted); text-transform: uppercase; margin-bottom: 10px;
  }

  .stat-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 0; border-bottom: 1px solid var(--border);
    font-size: 0.78rem;
  }
  .stat-row:last-child { border-bottom: none; }
  .stat-val { color: var(--accent); font-family: 'JetBrains Mono', monospace; font-weight: 500; }

  .mode-btn {
    width: 100%; padding: 9px 12px; border-radius: 8px;
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--muted); font-family: 'Syne', sans-serif;
    font-size: 0.78rem; cursor: pointer; text-align: left;
    transition: all 0.2s; display: flex; align-items: center; gap: 8px;
    margin-bottom: 6px;
  }
  .mode-btn:hover { border-color: var(--accent); color: var(--text); }
  .mode-btn.active { background: var(--glow); border-color: var(--accent); color: var(--accent); }
  .mode-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; flex-shrink: 0; }

  /* API Key modal */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.8);
    display: flex; align-items: center; justify-content: center;
    z-index: 100; backdrop-filter: blur(4px);
  }
  .modal {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 32px; width: 420px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    animation: modalIn 0.3s ease;
  }
  @keyframes modalIn { from{opacity:0;transform:scale(0.95)} to{opacity:1;transform:scale(1)} }
  .modal h2 { font-size: 1.3rem; font-weight: 800; margin-bottom: 6px; }
  .modal p { color: var(--muted); font-size: 0.82rem; margin-bottom: 20px; line-height: 1.6; }
  .modal input {
    width: 100%; padding: 12px 14px; border-radius: 10px;
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); font-family: 'JetBrains Mono', monospace;
    font-size: 0.82rem; outline: none; margin-bottom: 12px;
    transition: border-color 0.2s;
  }
  .modal input:focus { border-color: var(--accent); }
  .modal-btn {
    width: 100%; padding: 12px; border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none; color: #000; font-family: 'Syne', sans-serif;
    font-size: 0.88rem; font-weight: 700; cursor: pointer;
    transition: all 0.2s;
  }
  .modal-btn:hover { opacity: 0.9; transform: translateY(-1px); }

  .token-counter {
    font-family: 'JetBrains Mono', monospace; font-size: 0.68rem;
    color: var(--muted);
  }

  /* Scrollbar */
  .sidebar::-webkit-scrollbar,
  .right-panel::-webkit-scrollbar { width: 3px; }
  .sidebar::-webkit-scrollbar-thumb,
  .right-panel::-webkit-scrollbar-thumb { background: var(--border); }

  @media (max-width: 900px) {
    .right-panel { display: none; }
    .sidebar { width: 180px; }
  }
  @media (max-width: 640px) {
    .sidebar { display: none; }
    .messages { padding: 16px; }
    .input-area { padding: 12px 16px 16px; }
  }
</style>
</head>
<body>

<div class="blob1"></div>
<div class="blob2"></div>

<!-- API Key Modal -->
<div class="modal-overlay" id="apiModal">
  <div class="modal">
    <div style="font-size:32px;margin-bottom:12px">üîë</div>
    <h2>Connect Your API</h2>
    <p>Enter your BigModel.cn API key to start coding with AI. Your key is stored locally and never sent to our servers.</p>
    <input type="password" id="apiKeyInput" placeholder="sk-‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    <div style="margin-bottom:16px">
      <label style="display:flex;align-items:center;gap:8px;font-size:0.78rem;color:var(--muted);cursor:pointer">
        <input type="checkbox" id="rememberKey" checked style="accent-color:var(--accent)"> Remember API key
      </label>
    </div>
    <button class="modal-btn" onclick="saveApiKey()">üöÄ Launch CodeMind AI</button>
    <p style="margin-top:12px;font-size:0.72rem;text-align:center">
      <a href="https://bigmodel.cn" target="_blank" style="color:var(--accent);text-decoration:none">Get your API key ‚Üí</a>
    </p>
  </div>
</div>

<div class="app">
  <header>
    <div class="logo">
      <div class="logo-icon">‚ö°</div>
      Code<span>Mind</span> AI
    </div>
    <div class="header-right">
      <div class="lang-badge active" onclick="setLang('python')" id="lpy">Python</div>
      <div class="lang-badge" onclick="setLang('javascript')" id="ljs">JS</div>
      <div class="lang-badge" onclick="setLang('typescript')" id="lts">TS</div>
      <div class="lang-badge" onclick="setLang('rust')" id="lru">Rust</div>
      <div class="lang-badge" onclick="setLang('go')" id="lgo">Go</div>
      <div class="model-badge">
        <div class="model-dot"></div>
        GLM-4
      </div>
      <button class="action-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
    </div>
  </header>

  <div class="main">
    <!-- Sidebar -->
    <div class="sidebar">
      <button class="new-chat-btn" onclick="newChat()">+ New Chat</button>
      <div class="sidebar-label">Recent</div>
      <button class="sidebar-btn active" id="currentChat">
        <span class="icon">üí¨</span> Current Session
      </button>
      <div class="sidebar-label">Quick Actions</div>
      <button class="sidebar-btn" onclick="quickPrompt('Review my code for bugs and security issues')">
        <span class="icon">üîç</span> Code Review
      </button>
      <button class="sidebar-btn" onclick="quickPrompt('Optimize this code for better performance')">
        <span class="icon">‚ö°</span> Optimize
      </button>
      <button class="sidebar-btn" onclick="quickPrompt('Write unit tests for this code')">
        <span class="icon">üß™</span> Write Tests
      </button>
      <button class="sidebar-btn" onclick="quickPrompt('Explain this code step by step')">
        <span class="icon">üìñ</span> Explain
      </button>
      <button class="sidebar-btn" onclick="quickPrompt('Refactor this code to be cleaner and more maintainable')">
        <span class="icon">‚ôªÔ∏è</span> Refactor
      </button>
      <button class="sidebar-btn" onclick="quickPrompt('Add documentation and comments to this code')">
        <span class="icon">üìù</span> Document
      </button>
      <div class="sidebar-label">Tools</div>
      <button class="sidebar-btn" onclick="quickPrompt('Convert this code to ')">
        <span class="icon">üîÑ</span> Convert Lang
      </button>
      <button class="sidebar-btn" onclick="quickPrompt('Debug this error: ')">
        <span class="icon">üêõ</span> Debug Error
      </button>
    </div>

    <!-- Chat -->
    <div class="chat-area">
      <div class="messages" id="messages">
        <div class="welcome" id="welcome">
          <div class="welcome-icon">‚ö°</div>
          <div>
            <h1>Ultimate Coding<br><span>Intelligence</span></h1>
            <p>Powered by BigModel.cn GLM-4. Ask anything about code ‚Äî from debugging to architecture design.</p>
          </div>
          <div class="suggestions">
            <div class="suggest-card" onclick="quickPrompt('Write a REST API in Python with FastAPI including authentication')">
              <div class="s-icon">üêç</div>
              <div class="s-title">Build a REST API</div>
              <div class="s-sub">FastAPI + Auth</div>
            </div>
            <div class="suggest-card" onclick="quickPrompt('Explain async/await in JavaScript with examples')">
              <div class="s-icon">‚ö°</div>
              <div class="s-title">Async/Await</div>
              <div class="s-sub">JS deep dive</div>
            </div>
            <div class="suggest-card" onclick="quickPrompt('Implement a binary search tree in TypeScript')">
              <div class="s-icon">üå≥</div>
              <div class="s-title">Data Structures</div>
              <div class="s-sub">BST in TypeScript</div>
            </div>
            <div class="suggest-card" onclick="quickPrompt('Write a Docker compose setup for a full-stack app')">
              <div class="s-icon">üê≥</div>
              <div class="s-title">Docker Setup</div>
              <div class="s-sub">Full-stack compose</div>
            </div>
          </div>
        </div>
      </div>

      <div class="input-area">
        <div class="input-wrap">
          <textarea id="userInput" placeholder="Ask me to write, debug, explain, or optimize code..." rows="1"
            onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
          <div class="input-actions">
            <button class="action-btn" title="Attach file" onclick="attachFile()">üìé</button>
            <button id="sendBtn" onclick="sendMessage()" title="Send (Enter)">‚û§</button>
          </div>
        </div>
        <div class="input-hint">
          <span>Press <kbd style="background:var(--surface2);padding:1px 5px;border-radius:4px;border:1px solid var(--border)">Enter</kbd> to send ¬∑ <kbd style="background:var(--surface2);padding:1px 5px;border-radius:4px;border:1px solid var(--border)">Shift+Enter</kbd> for newline</span>
          <span class="token-counter" id="tokenCount">0 tokens</span>
        </div>
      </div>
    </div>

    <!-- Right panel -->
    <div class="right-panel">
      <div class="panel-section">
        <div class="panel-title">Session Stats</div>
        <div class="stat-row">
          <span>Messages</span>
          <span class="stat-val" id="msgCount">0</span>
        </div>
        <div class="stat-row">
          <span>Tokens Used</span>
          <span class="stat-val" id="totalTokens">0</span>
        </div>
        <div class="stat-row">
          <span>Language</span>
          <span class="stat-val" id="currentLang">Python</span>
        </div>
        <div class="stat-row">
          <span>Model</span>
          <span class="stat-val">GLM-4</span>
        </div>
      </div>

      <div class="panel-section">
        <div class="panel-title">AI Mode</div>
        <button class="mode-btn active" id="mode-code" onclick="setMode('code')">
          <div class="mode-dot"></div> Code Expert
        </button>
        <button class="mode-btn" id="mode-debug" onclick="setMode('debug')">
          <div class="mode-dot"></div> Debugger
        </button>
        <button class="mode-btn" id="mode-teach" onclick="setMode('teach')">
          <div class="mode-dot"></div> Teacher
        </button>
        <button class="mode-btn" id="mode-review" onclick="setMode('review')">
          <div class="mode-dot"></div> Code Review
        </button>
      </div>

      <div class="panel-section">
        <div class="panel-title">Keyboard Shortcuts</div>
        <div class="stat-row" style="font-size:0.72rem">
          <span>Send message</span>
          <span class="stat-val">‚Üµ</span>
        </div>
        <div class="stat-row" style="font-size:0.72rem">
          <span>New line</span>
          <span class="stat-val">‚áß‚Üµ</span>
        </div>
        <div class="stat-row" style="font-size:0.72rem">
          <span>New chat</span>
          <span class="stat-val">‚åòK</span>
        </div>
        <div class="stat-row" style="font-size:0.72rem">
          <span>Copy last code</span>
          <span class="stat-val">‚åò‚áßC</span>
        </div>
      </div>

      <div class="panel-section">
        <button class="mode-btn" onclick="clearChat()" style="color:var(--accent3);border-color:rgba(255,107,53,0.3)">
          <div class="mode-dot" style="background:var(--accent3)"></div> Clear Chat
        </button>
        <button class="mode-btn" onclick="exportChat()">
          <div class="mode-dot"></div> Export Chat
        </button>
      </div>
    </div>
  </div>
</div>

<script>
let apiKey = localStorage.getItem('bigmodel_api_key') || '';
let messages = [];
let selectedLang = 'python';
let currentMode = 'code';
let totalTokensUsed = 0;
let msgCount = 0;

const modePrompts = {
  code: 'You are CodeMind AI, an elite coding assistant powered by BigModel.cn. You specialize in writing clean, efficient, production-ready code. Always format code with proper syntax highlighting using triple backticks and language names. Be concise but thorough.',
  debug: 'You are CodeMind AI in Debugger mode. Your specialty is identifying and fixing bugs, analyzing stack traces, and explaining what went wrong and why. Provide step-by-step debugging guidance.',
  teach: 'You are CodeMind AI in Teacher mode. Explain concepts clearly with analogies and examples. Break down complex topics, teach best practices, and make sure the user understands the "why" behind the code.',
  review: 'You are CodeMind AI in Code Review mode. Analyze code for bugs, security vulnerabilities, performance issues, and style improvements. Be thorough and constructive. Rate code quality 1-10.'
};

// Init
if (apiKey) document.getElementById('apiModal').style.display = 'none';

function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key) { alert('Please enter your API key'); return; }
  apiKey = key;
  if (document.getElementById('rememberKey').checked) {
    localStorage.setItem('bigmodel_api_key', key);
  }
  document.getElementById('apiModal').style.display = 'none';
}

function openSettings() {
  apiKey = '';
  document.getElementById('apiKeyInput').value = '';
  document.getElementById('apiModal').style.display = 'flex';
}

function setLang(lang) {
  selectedLang = lang;
  document.querySelectorAll('.lang-badge').forEach(b => b.classList.remove('active'));
  const ids = { python:'lpy', javascript:'ljs', typescript:'lts', rust:'lru', go:'lgo' };
  if (ids[lang]) document.getElementById(ids[lang]).classList.add('active');
  document.getElementById('currentLang').textContent = lang.charAt(0).toUpperCase() + lang.slice(1);
}

function setMode(mode) {
  currentMode = mode;
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('mode-' + mode)?.classList.add('active');
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 180) + 'px';
  const chars = el.value.length;
  document.getElementById('tokenCount').textContent = Math.ceil(chars / 4) + ' tokens';
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

document.addEventListener('keydown', e => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); newChat(); }
});

function quickPrompt(text) {
  const input = document.getElementById('userInput');
  input.value = text;
  input.focus();
  autoResize(input);
}

function attachFile() {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = '.py,.js,.ts,.go,.rs,.java,.cpp,.c,.html,.css,.json';
  input.onchange = async e => {
    const file = e.target.files[0];
    const text = await file.text();
    const input2 = document.getElementById('userInput');
    input2.value = `Here is my ${file.name}:\n\`\`\`\n${text}\n\`\`\`\n\nPlease review it.`;
    autoResize(input2);
  };
  input.click();
}

function newChat() {
  messages = [];
  msgCount = 0;
  document.getElementById('messages').innerHTML = '';
  document.getElementById('welcome').style.display = 'flex';
  const messagesDiv = document.getElementById('messages');
  messagesDiv.appendChild(document.getElementById('welcome'));
  document.getElementById('welcome').style.display = 'flex';
  document.getElementById('msgCount').textContent = '0';
  
  // Rebuild welcome
  const msgs = document.getElementById('messages');
  msgs.innerHTML = `
    <div class="welcome" id="welcome">
      <div class="welcome-icon">‚ö°</div>
      <div>
        <h1>Ultimate Coding<br><span>Intelligence</span></h1>
        <p>Powered by BigModel.cn GLM-4. Ask anything about code ‚Äî from debugging to architecture design.</p>
      </div>
      <div class="suggestions">
        <div class="suggest-card" onclick="quickPrompt('Write a REST API in Python with FastAPI including authentication')">
          <div class="s-icon">üêç</div><div class="s-title">Build a REST API</div><div class="s-sub">FastAPI + Auth</div>
        </div>
        <div class="suggest-card" onclick="quickPrompt('Explain async/await in JavaScript with examples')">
          <div class="s-icon">‚ö°</div><div class="s-title">Async/Await</div><div class="s-sub">JS deep dive</div>
        </div>
        <div class="suggest-card" onclick="quickPrompt('Implement a binary search tree in TypeScript')">
          <div class="s-icon">üå≥</div><div class="s-title">Data Structures</div><div class="s-sub">BST in TypeScript</div>
        </div>
        <div class="suggest-card" onclick="quickPrompt('Write a Docker compose setup for a full-stack app')">
          <div class="s-icon">üê≥</div><div class="s-title">Docker Setup</div><div class="s-sub">Full-stack compose</div>
        </div>
      </div>
    </div>`;
  messages = [];
}

function clearChat() { newChat(); }

function exportChat() {
  const content = messages.map(m => `[${m.role.toUpperCase()}]\n${m.content}\n`).join('\n---\n');
  const blob = new Blob([content], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'codemind-chat.txt';
  a.click();
}

function renderContent(text) {
  // Parse code blocks
  const parts = text.split(/(```[\w]*\n[\s\S]*?```)/g);
  return parts.map(part => {
    const codeMatch = part.match(/```([\w]*)\n([\s\S]*?)```/);
    if (codeMatch) {
      const lang = codeMatch[1] || 'code';
      const code = escapeHtml(codeMatch[2]);
      const id = 'code_' + Math.random().toString(36).slice(2);
      return `<div class="code-wrap">
        <div class="code-header">
          <span class="lang-tag">${lang}</span>
          <button class="copy-btn" onclick="copyCode('${id}')">Copy</button>
        </div>
        <pre id="${id}">${highlightCode(code, lang)}</pre>
      </div>`;
    }
    // Inline code
    return part.replace(/`([^`]+)`/g, '<code style="background:var(--surface2);padding:2px 6px;border-radius:4px;font-family:JetBrains Mono,monospace;font-size:0.82em;color:var(--accent2)">$1</code>')
      .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
      .replace(/\n/g, '<br>');
  }).join('');
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function highlightCode(code, lang) {
  if (['python','javascript','typescript','go','rust','java','cpp','c'].includes(lang)) {
    const keywords = /\b(def|class|import|from|return|if|else|elif|for|while|in|not|and|or|is|None|True|False|async|await|with|as|try|except|finally|raise|yield|lambda|pass|break|continue|const|let|var|function|arrow|=>|interface|type|struct|impl|fn|pub|mod|use|mut|let|match|enum|trait|where|new|this|super|extends|implements|export|default|void|int|string|bool|float|double|char|null|undefined|typeof|instanceof|switch|case|do|goto|package|func|chan|go|select|defer|map|make|range|len|cap|append|copy|delete|close|make|new|print|println|fmt|err|error|panic|recover)\b/g;
    const strings = /(["'`])(?:\\.|[^\\])*?\1/g;
    const comments = /(\/\/.*|#.*|\/\*[\s\S]*?\*\/)/g;
    const numbers = /\b(\d+\.?\d*)\b/g;
    const funcs = /\b([a-zA-Z_]\w*)\s*(?=\()/g;
    
    return code
      .replace(strings, m => `<span class="str">${m}</span>`)
      .replace(comments, m => `<span class="cm">${m}</span>`)
      .replace(keywords, m => `<span class="kw">${m}</span>`)
      .replace(numbers, m => `<span class="num">${m}</span>`)
      .replace(funcs, (m, fn) => `<span class="fn">${fn}</span>(`);
  }
  return code;
}

function copyCode(id) {
  const el = document.getElementById(id);
  const text = el.innerText;
  navigator.clipboard.writeText(text).then(() => {
    const btn = el.previousElementSibling.querySelector('.copy-btn');
    btn.textContent = 'Copied!';
    btn.style.color = 'var(--accent)';
    setTimeout(() => { btn.textContent = 'Copy'; btn.style.color = ''; }, 2000);
  });
}

function addMessage(role, content) {
  const welcome = document.getElementById('welcome');
  if (welcome) welcome.remove();

  const messagesDiv = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = `msg ${role}`;

  const avatarHtml = role === 'ai' 
    ? `<div class="avatar ai">AI</div>`
    : `<div class="avatar user">üë§</div>`;
  
  const bubbleContent = role === 'ai' ? renderContent(content) : escapeHtml(content).replace(/\n/g,'<br>');

  div.innerHTML = `${avatarHtml}<div class="bubble">${bubbleContent}</div>`;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  return div;
}

function addThinking() {
  const messagesDiv = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'msg ai';
  div.id = 'thinking';
  div.innerHTML = `<div class="avatar ai">AI</div><div class="bubble"><div class="thinking"><span></span><span></span><span></span></div></div>`;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

async function sendMessage() {
  const input = document.getElementById('userInput');
  const text = input.value.trim();
  if (!text || !apiKey) {
    if (!apiKey) openSettings();
    return;
  }

  input.value = '';
  input.style.height = 'auto';
  document.getElementById('tokenCount').textContent = '0 tokens';
  document.getElementById('sendBtn').disabled = true;

  addMessage('user', text);
  msgCount++;
  document.getElementById('msgCount').textContent = msgCount;

  messages.push({ role: 'user', content: text });
  addThinking();

  try {
    const response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: 'glm-4',
        messages: [
          { role: 'system', content: modePrompts[currentMode] + ` The user prefers ${selectedLang} as their primary language.` },
          ...messages
        ],
        max_tokens: 4096,
        temperature: 0.7
      })
    });

    const data = await response.json();
    document.getElementById('thinking')?.remove();

    if (data.choices && data.choices[0]) {
      const reply = data.choices[0].message.content;
      messages.push({ role: 'assistant', content: reply });
      addMessage('ai', reply);
      msgCount++;
      document.getElementById('msgCount').textContent = msgCount;
      
      if (data.usage) {
        totalTokensUsed += data.usage.total_tokens || 0;
        document.getElementById('totalTokens').textContent = totalTokensUsed.toLocaleString();
      }
    } else {
      const errMsg = data.error?.message || JSON.stringify(data);
      addMessage('ai', `‚ö†Ô∏è API Error: ${errMsg}`);
    }
  } catch (err) {
    document.getElementById('thinking')?.remove();
    addMessage('ai', `‚ö†Ô∏è Network error: ${err.message}. Please check your API key and connection.`);
  }

  document.getElementById('sendBtn').disabled = false;
  input.focus();
}
</script>
</body>
</html>
