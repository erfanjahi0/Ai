<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NexusAI ‚Äî Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500&family=DM+Mono:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #080c14; --surface: #0d1220; --surface2: #131929; --surface3: #1a2235;
      --border: rgba(99,179,237,0.1); --border2: rgba(99,179,237,0.2);
      --accent: #38bdf8; --accent2: #818cf8; --accent3: #34d399;
      --text: #e2e8f0; --text-muted: #64748b; --text-dim: #94a3b8;
      --danger: #f87171; --warning: #fbbf24;
    }
    html { height: 100%; }
    body { height: 100%; height: 100dvh; overflow: hidden; font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(99,179,237,0.2); border-radius: 3px; }

    /* LAYOUT ‚Äî fixed full viewport */
    .app { display: flex; position: fixed; inset: 0; width: 100%; height: 100%; overflow: hidden; }

    /* SIDEBAR */
    .sidebar {
      width: 260px; min-width: 260px; height: 100%;
      background: var(--surface); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; z-index: 50; flex-shrink: 0;
    }
    .sidebar-header { display: flex; align-items: center; justify-content: space-between; padding: 0 14px; height: 56px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .sidebar-logo { display: flex; align-items: center; gap: 8px; text-decoration: none; color: var(--text); font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.05rem; }
    .logo-icon { color: var(--accent); font-size: 1.2rem; filter: drop-shadow(0 0 6px var(--accent)); }
    .sidebar-close-btn { display: none; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; padding: 4px 8px; border-radius: 6px; }
    .sidebar-close-btn:hover { background: var(--surface2); color: var(--text); }
    .btn-new-chat { margin: 10px; padding: 9px 14px; border-radius: 10px; border: 1px dashed var(--border2); background: transparent; color: var(--text-dim); cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 0.88rem; display: flex; align-items: center; gap: 8px; transition: all 0.2s; flex-shrink: 0; }
    .btn-new-chat:hover { background: rgba(56,189,248,0.06); border-color: var(--accent); color: var(--accent); }
    .sidebar-label { font-family: 'DM Mono', monospace; font-size: 0.65rem; letter-spacing: 2px; color: var(--text-muted); padding: 8px 12px 4px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .del-all-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.85rem; transition: color 0.2s; padding: 2px 4px; }
    .del-all-btn:hover { color: var(--danger); }
    .chat-list { flex: 1; overflow-y: auto; padding: 4px 8px; display: flex; flex-direction: column; gap: 2px; }
    .chat-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 8px; cursor: pointer; transition: background 0.15s; }
    .chat-item:hover { background: var(--surface2); }
    .chat-item.active { background: rgba(56,189,248,0.08); }
    .chat-item-text { flex: 1; font-size: 0.83rem; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-item.active .chat-item-text { color: var(--accent); }
    .chat-item-actions { display: none; gap: 2px; }
    .chat-item:hover .chat-item-actions { display: flex; }
    .chat-action-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.78rem; padding: 3px 5px; border-radius: 4px; transition: all 0.15s; }
    .chat-action-btn:hover { background: var(--surface3); color: var(--text); }
    .chat-action-btn.del:hover { color: var(--danger); }
    .sidebar-bottom { border-top: 1px solid var(--border); padding: 10px 12px; display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .user-avatar { width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent2)); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; color: var(--bg); flex-shrink: 0; }
    .user-meta { flex: 1; min-width: 0; }
    .user-name { display: block; font-size: 0.82rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-email { display: block; font-size: 0.7rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .logout-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; padding: 5px; border-radius: 6px; transition: all 0.2s; flex-shrink: 0; }
    .logout-btn:hover { color: var(--danger); background: rgba(248,113,113,0.1); }

    /* MAIN */
    .main { flex: 1; display: flex; flex-direction: column; min-width: 0; min-height: 0; overflow: hidden; }

    /* TOPBAR */
    .topbar { height: 56px; min-height: 56px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 14px; gap: 10px; background: var(--bg); flex-shrink: 0; z-index: 10; }
    .topbar-left { display: flex; align-items: center; gap: 8px; min-width: 0; flex: 1; }
    .menu-btn { display: none; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.1rem; padding: 5px; border-radius: 6px; }
    .menu-btn:hover { background: var(--surface2); color: var(--text); }
    .chat-title-wrap { display: flex; align-items: center; gap: 6px; min-width: 0; }
    .chat-title-display { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 260px; }
    .edit-title-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.85rem; padding: 2px 5px; opacity: 0; transition: opacity 0.2s; }
    .chat-title-wrap:hover .edit-title-btn { opacity: 1; }
    .topbar-right { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
    .model-select-wrap { position: relative; }
    .model-btn { display: flex; align-items: center; gap: 6px; padding: 6px 11px; border-radius: 50px; border: 1px solid var(--border); background: var(--surface2); color: var(--text-dim); cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 0.82rem; transition: all 0.2s; white-space: nowrap; }
    .model-btn:hover { border-color: var(--border2); color: var(--text); }
    .mdot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    .mdot.flash { background: var(--warning); box-shadow: 0 0 5px var(--warning); }
    .mdot.standard { background: var(--accent); box-shadow: 0 0 5px var(--accent); }
    .mdot.zero { background: var(--accent2); box-shadow: 0 0 5px var(--accent2); }
    .chevron { font-size: 0.65rem; }
    .model-dropdown { display: none; position: absolute; top: calc(100% + 6px); right: 0; min-width: 210px; background: var(--surface); border: 1px solid var(--border2); border-radius: 12px; overflow: hidden; z-index: 200; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
    .model-dropdown.open { display: block; animation: fadeDown 0.15s ease; }
    @keyframes fadeDown { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }
    .model-option { display: flex; align-items: center; gap: 9px; padding: 10px 14px; cursor: pointer; font-size: 0.85rem; transition: background 0.15s; }
    .model-option:hover { background: var(--surface2); }
    .model-option.selected { background: rgba(56,189,248,0.06); color: var(--accent); }
    .model-desc { font-size: 0.7rem; color: var(--text-muted); margin-left: auto; }
    .think-btn { display: flex; align-items: center; gap: 5px; padding: 6px 11px; border-radius: 50px; border: 1px solid var(--border); background: var(--surface2); color: var(--text-muted); cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 0.82rem; transition: all 0.2s; }
    .think-btn:hover { color: var(--text); border-color: var(--border2); }
    .think-btn.active { border-color: rgba(129,140,248,0.5); color: var(--accent2); background: rgba(129,140,248,0.08); }
    .settings-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.1rem; padding: 5px; border-radius: 6px; transition: all 0.2s; }
    .settings-btn:hover { color: var(--text); background: var(--surface2); }
    .think-banner { display: none; align-items: center; gap: 8px; padding: 7px 16px; flex-shrink: 0; background: rgba(129,140,248,0.06); border-bottom: 1px solid rgba(129,140,248,0.15); font-size: 0.8rem; color: var(--accent2); font-family: 'DM Mono', monospace; }
    .think-banner.show { display: flex; }
    @keyframes pulseOp { 0%,100%{opacity:1} 50%{opacity:0.3} }
    .think-pulse { animation: pulseOp 1.5s ease infinite; }

    /* MESSAGES */
    .messages { flex: 1; min-height: 0; overflow-y: auto; padding: 20px 16px; display: flex; flex-direction: column; gap: 2px; scroll-behavior: smooth; }
    .welcome-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; gap: 14px; padding: 40px 20px; min-height: 300px; }
    .welcome-icon { font-size: 2.6rem; color: var(--accent); filter: drop-shadow(0 0 14px var(--accent)); }
    .welcome-screen h2 { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.6rem; letter-spacing: -1px; }
    .welcome-screen p { color: var(--text-muted); font-size: 0.95rem; }
    .quick-prompts { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 6px; }
    .qp-btn { padding: 9px 16px; border-radius: 50px; border: 1px solid var(--border); background: var(--surface); color: var(--text-dim); cursor: pointer; font-size: 0.85rem; font-family: 'DM Sans', sans-serif; transition: all 0.2s; }
    .qp-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(56,189,248,0.05); }
    .message { display: flex; gap: 12px; padding: 10px 0; max-width: 820px; margin: 0 auto; width: 100%; animation: msgIn 0.25s ease; }
    @keyframes msgIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
    .message.user { flex-direction: row-reverse; }
    .msg-avatar { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 0.82rem; margin-top: 2px; }
    .message.ai .msg-avatar { background: linear-gradient(135deg,rgba(56,189,248,0.15),rgba(129,140,248,0.15)); border: 1px solid rgba(56,189,248,0.25); color: var(--accent); }
    .message.user .msg-avatar { background: linear-gradient(135deg,rgba(56,189,248,0.3),rgba(129,140,248,0.3)); color: var(--bg); font-weight: 700; }
    .msg-content { flex: 1; min-width: 0; }
    .message.user .msg-content { display: flex; flex-direction: column; align-items: flex-end; }
    .msg-bubble { padding: 10px 14px; border-radius: 14px; font-size: 0.9rem; line-height: 1.65; }
    .message.user .msg-bubble { background: linear-gradient(135deg,rgba(56,189,248,0.1),rgba(129,140,248,0.1)); border: 1px solid rgba(56,189,248,0.18); border-radius: 14px 14px 4px 14px; max-width: 85%; }
    .message.ai .msg-bubble { background: transparent; border: none; padding: 4px 0; width: 100%; }
    .msg-bubble p { margin-bottom: 10px; }
    .msg-bubble p:last-child { margin-bottom: 0; }
    .msg-bubble h1,.msg-bubble h2,.msg-bubble h3 { font-family: 'Syne', sans-serif; margin: 16px 0 8px; }
    .msg-bubble h1 { font-size: 1.3rem; } .msg-bubble h2 { font-size: 1.1rem; } .msg-bubble h3 { font-size: 1rem; }
    .msg-bubble ul,.msg-bubble ol { padding-left: 18px; margin-bottom: 10px; }
    .msg-bubble li { margin-bottom: 3px; }
    .msg-bubble a { color: var(--accent); }
    .msg-bubble blockquote { border-left: 3px solid var(--border2); padding-left: 12px; color: var(--text-muted); margin: 10px 0; }
    .msg-bubble table { border-collapse: collapse; width: 100%; margin: 10px 0; font-size: 0.85rem; }
    .msg-bubble th,.msg-bubble td { border: 1px solid var(--border); padding: 7px 10px; text-align: left; }
    .msg-bubble th { background: var(--surface2); }
    .msg-bubble code:not(pre code) { font-family: 'DM Mono', monospace; font-size: 0.82em; background: rgba(56,189,248,0.08); border: 1px solid rgba(56,189,248,0.15); padding: 2px 5px; border-radius: 4px; color: var(--accent); }
    .code-wrapper { position: relative; margin: 10px 0; border-radius: 10px; overflow: hidden; border: 1px solid var(--border); }
    .code-header { display: flex; align-items: center; justify-content: space-between; padding: 7px 12px; background: #0f1520; border-bottom: 1px solid var(--border); }
    .code-lang-label { font-family: 'DM Mono', monospace; font-size: 0.7rem; color: var(--accent); letter-spacing: 1px; }
    .code-actions-row { display: flex; gap: 5px; }
    .code-btn { background: var(--surface2); border: 1px solid var(--border); border-radius: 5px; padding: 3px 9px; font-size: 0.72rem; color: var(--text-muted); cursor: pointer; font-family: 'DM Mono', monospace; transition: all 0.2s; }
    .code-btn:hover { color: var(--accent); border-color: rgba(56,189,248,0.3); }
    .code-btn.ok { color: var(--accent3); border-color: rgba(52,211,153,0.3); }
    .code-wrapper pre { margin: 0 !important; border-radius: 0 !important; max-height: 450px; overflow: auto; }
    .code-wrapper pre code { font-family: 'DM Mono', monospace !important; font-size: 0.8rem !important; line-height: 1.55 !important; }
    .thinking-block { border: 1px solid rgba(129,140,248,0.2); border-radius: 10px; margin-bottom: 12px; overflow: hidden; }
    .thinking-toggle { display: flex; align-items: center; gap: 8px; padding: 9px 12px; background: rgba(129,140,248,0.05); cursor: pointer; border: none; width: 100%; text-align: left; color: var(--accent2); font-family: 'DM Mono', monospace; font-size: 0.78rem; transition: background 0.2s; }
    .thinking-toggle:hover { background: rgba(129,140,248,0.1); }
    .thinking-content { padding: 12px; font-size: 0.82rem; color: var(--text-muted); line-height: 1.6; white-space: pre-wrap; display: none; }
    .thinking-content.open { display: block; }
    .think-arrow { transition: transform 0.2s; display: inline-block; font-size: 0.7rem; }
    .think-arrow.open { transform: rotate(90deg); }
    .file-downloads { display: flex; flex-wrap: wrap; gap: 7px; margin-top: 10px; }
    .file-dl-btn { display: inline-flex; align-items: center; gap: 7px; padding: 6px 13px; border-radius: 50px; cursor: pointer; border: 1px solid rgba(52,211,153,0.25); background: rgba(52,211,153,0.06); color: var(--accent3); font-size: 0.8rem; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
    .file-dl-btn:hover { background: rgba(52,211,153,0.14); border-color: rgba(52,211,153,0.45); }
    .typing-dots { display: inline-flex; gap: 4px; padding: 6px 0; }
    .typing-dots span { width: 6px; height: 6px; background: var(--text-muted); border-radius: 50%; animation: bounce 1.3s ease infinite; }
    .typing-dots span:nth-child(2) { animation-delay: 0.18s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.36s; }
    @keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-7px)} }
    .msg-actions { display: flex; gap: 5px; margin-top: 6px; opacity: 0; transition: opacity 0.2s; }
    .message:hover .msg-actions { opacity: 1; }
    .msg-act-btn { background: none; border: 1px solid var(--border); border-radius: 5px; padding: 3px 9px; font-size: 0.72rem; color: var(--text-muted); cursor: pointer; font-family: 'DM Mono', monospace; transition: all 0.2s; }
    .msg-act-btn:hover { color: var(--accent); border-color: rgba(56,189,248,0.3); }
    .error-bubble { background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.25); border-radius: 10px; padding: 10px 14px; color: var(--danger); font-size: 0.86rem; }
    /* Streaming cursor */
    .sb::after { content:'‚ñã'; display:inline-block; color:var(--accent); animation:blink 0.7s step-end infinite; margin-left:1px; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

    /* INPUT AREA ‚Äî pinned to bottom */
    .input-area { border-top: 1px solid var(--border); background: var(--bg); padding: 10px 16px 14px; flex-shrink: 0; }
    .attachment-strip { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
    .att-chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 50px; background: var(--surface2); border: 1px solid var(--border); font-size: 0.78rem; color: var(--text-dim); }
    .att-chip-img { width: 26px; height: 26px; border-radius: 4px; object-fit: cover; }
    .att-chip-del { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.9rem; padding: 0 2px; line-height: 1; transition: color 0.15s; }
    .att-chip-del:hover { color: var(--danger); }
    .input-row { display: flex; align-items: flex-end; gap: 8px; }
    .attach-btn { background: none; border: 1px solid var(--border); border-radius: 8px; color: var(--text-muted); cursor: pointer; padding: 8px; flex-shrink: 0; display: flex; transition: all 0.2s; }
    .attach-btn:hover { border-color: rgba(56,189,248,0.35); color: var(--accent); }
    .textarea-wrap { flex: 1; }
    #msgInput { width: 100%; resize: none; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.9rem; line-height: 1.5; padding: 9px 13px; outline: none; transition: border-color 0.2s; display: block; overflow-y: hidden; max-height: 180px; }
    #msgInput:focus { border-color: rgba(56,189,248,0.3); }
    #msgInput::placeholder { color: var(--text-muted); }
    .input-right { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; flex-shrink: 0; }
    .char-count { font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--text-muted); }
    .send-btn { width: 36px; height: 36px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--accent), var(--accent2)); color: var(--bg); transition: all 0.2s; flex-shrink: 0; }
    .send-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .send-btn:not(:disabled):hover { transform: scale(1.07); }
    .stop-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid rgba(248,113,113,0.35); background: var(--surface2); color: var(--danger); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; transition: all 0.2s; flex-shrink: 0; }
    .stop-btn:hover { background: rgba(248,113,113,0.1); }

    /* MODALS */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 300; align-items: center; justify-content: center; backdrop-filter: blur(6px); }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--surface); border: 1px solid var(--border2); border-radius: 18px; width: 100%; max-width: 480px; overflow: hidden; animation: mIn 0.18s ease; margin: 16px; }
    .modal.sm { max-width: 340px; }
    @keyframes mIn { from{opacity:0;transform:scale(0.94)} to{opacity:1;transform:scale(1)} }
    .modal-head { display: flex; align-items: center; justify-content: space-between; padding: 16px 18px; border-bottom: 1px solid var(--border); }
    .modal-head h3 { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1rem; }
    .modal-x { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.9rem; padding: 3px 7px; border-radius: 5px; transition: all 0.2s; }
    .modal-x:hover { color: var(--text); background: var(--surface2); }
    .modal-body { padding: 18px; }
    .sg { margin-bottom: 20px; }
    .sg label { display: block; font-size: 0.84rem; font-weight: 500; margin-bottom: 7px; }
    .sg .hint { font-size: 0.74rem; color: var(--text-muted); margin-top: 5px; }
    .range-row { display: flex; align-items: center; gap: 10px; }
    input[type=range] { flex: 1; accent-color: var(--accent); cursor: pointer; }
    .range-val { font-family: 'DM Mono', monospace; font-size: 0.82rem; color: var(--accent); min-width: 38px; text-align: right; }
    .modal textarea { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.86rem; padding: 9px 11px; resize: vertical; outline: none; transition: border-color 0.2s; line-height: 1.5; }
    .modal textarea:focus { border-color: rgba(56,189,248,0.3); }
    .tgl-row { display: flex; align-items: center; justify-content: space-between; }
    .toggle { position: relative; display: inline-block; width: 42px; height: 22px; cursor: pointer; flex-shrink: 0; }
    .toggle input { opacity:0; width:0; height:0; }
    .tgl-sl { position: absolute; inset: 0; background: var(--surface3); border-radius: 22px; transition: background 0.3s; }
    .tgl-sl::before { content:''; position:absolute; width:16px; height:16px; border-radius:50%; background: var(--text-muted); left:3px; bottom:3px; transition:transform 0.3s, background 0.3s; }
    .toggle input:checked + .tgl-sl { background: rgba(56,189,248,0.18); border: 1px solid rgba(56,189,248,0.3); }
    .toggle input:checked + .tgl-sl::before { transform: translateX(20px); background: var(--accent); }
    .rename-input { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:0.9rem; padding:9px 12px; outline:none; transition:border-color 0.2s; margin-bottom:12px; }
    .rename-input:focus { border-color:rgba(56,189,248,0.3); }
    .btn-save { width:100%; padding:9px; border-radius:50px; border:none; background:linear-gradient(135deg,var(--accent),var(--accent2)); color:var(--bg); font-family:'Syne',sans-serif; font-weight:700; cursor:pointer; font-size:0.9rem; }
    .del-row { display:flex; gap:10px; }
    .btn-cancel-m { flex:1; padding:9px; border-radius:50px; border:1px solid var(--border); background:transparent; color:var(--text-dim); cursor:pointer; font-size:0.88rem; transition:all 0.2s; }
    .btn-cancel-m:hover { border-color:var(--border2); }
    .btn-danger-m { flex:1; padding:9px; border-radius:50px; border:1px solid rgba(248,113,113,0.3); background:rgba(248,113,113,0.1); color:var(--danger); cursor:pointer; font-size:0.88rem; transition:all 0.2s; }
    .btn-danger-m:hover { background:rgba(248,113,113,0.2); }
    .sidebar-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:49; }

    /* RESPONSIVE */
    @media (max-width: 760px) {
      .sidebar { position:fixed; left:0; top:0; height:100%; transform:translateX(-100%); transition:transform 0.3s ease; z-index:100; }
      .sidebar.open { transform:translateX(0); box-shadow:4px 0 24px rgba(0,0,0,0.5); }
      .sidebar-overlay.open { display:block; }
      .sidebar-close-btn { display:block; }
      .menu-btn { display:block; }
      .chat-title-display { max-width:130px; font-size:0.85rem; }
      .think-lbl { display:none; }
      .model-btn { padding:5px 8px; font-size:0.78rem; }
      .messages { padding:10px 8px; }
      .input-area { padding:8px 10px env(safe-area-inset-bottom, 10px); }
      .topbar { padding:0 10px; height:52px; min-height:52px; }
    }
  </style>
</head>
<body>
<div class="app">
  <!-- SIDEBAR OVERLAY -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="../index.html" class="sidebar-logo">
        <span class="logo-icon">‚¨°</span>
        <span>NexusAI</span>
      </a>
      <button class="sidebar-close-btn" id="sidebarCloseBtn">‚úï</button>
    </div>
    <button class="btn-new-chat" id="newChatBtn">
      <span style="font-size:1.1rem;line-height:1">+</span> New Chat
    </button>
    <div class="sidebar-label">
      CONVERSATIONS
      <button class="del-all-btn" id="deleteAllBtn" title="Delete all">üóë</button>
    </div>
    <div class="chat-list" id="chatList"></div>
    <div class="sidebar-bottom">
      <div class="user-avatar" id="userAvatar">U</div>
      <div class="user-meta">
        <span class="user-name" id="userName">User</span>
        <span class="user-email" id="userEmail">‚Äî</span>
      </div>
      <button class="logout-btn" id="logoutBtn" title="Sign out">‚èª</button>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <header class="topbar">
      <div class="topbar-left">
        <button class="menu-btn" id="menuBtn">‚ò∞</button>
        <div class="chat-title-wrap">
          <span class="chat-title-display" id="chatTitle">New Chat</span>
          <button class="edit-title-btn" id="editTitleBtn" title="Rename">‚úé</button>
        </div>
      </div>
      <div class="topbar-right">
        <div class="model-select-wrap">
          <button class="model-btn" id="modelBtn">
            <span class="mdot standard" id="modelDot"></span>
            <span id="modelLabel">GLM-5</span>
            <span class="chevron">‚ñæ</span>
          </button>
          <div class="model-dropdown" id="modelDropdown">
            <div class="model-option selected" data-id="glm-5" data-label="GLM-5" data-dot="standard">
              <span class="mdot standard"></span> GLM-5 <span class="model-desc">Latest Flagship</span>
            </div>
            <div class="model-option" data-id="glm-4.7" data-label="GLM-4.7" data-dot="flash">
              <span class="mdot flash"></span> GLM-4.7 <span class="model-desc">Fast ¬∑ Reasoning</span>
            </div>
            <div class="model-option" data-id="glm-4.6" data-label="GLM-4.6" data-dot="flash">
              <span class="mdot flash"></span> GLM-4.6 <span class="model-desc">Balanced</span>
            </div>
            <div class="model-option" data-id="glm-4.5" data-label="GLM-4.5" data-dot="zero">
              <span class="mdot zero"></span> GLM-4.5 <span class="model-desc">96K ¬∑ Thinking</span>
            </div>
            <div class="model-option" data-id="glm-4.5-air" data-label="GLM-4.5 Air" data-dot="zero">
              <span class="mdot zero"></span> GLM-4.5 Air <span class="model-desc">Light ¬∑ Fast</span>
            </div>
          </div>
        </div>
        <button class="think-btn" id="thinkBtn">
          <span>‚óé</span><span class="think-lbl">Think</span>
        </button>
        <button class="settings-btn" id="settingsBtn" title="Settings">‚öô</button>
      </div>
    </header>

    <div class="think-banner" id="thinkBanner">
      <span class="think-pulse">‚óé</span> Thinking Mode Active
    </div>

    <div class="messages" id="messages">
      <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-icon">‚¨°</div>
        <h2>How can I help you build?</h2>
        <p>Ask me anything ‚Äî code, analysis, files, and more.</p>
        <div class="quick-prompts">
          <button class="qp-btn" data-p="Write a full-stack Next.js app with REST API and PostgreSQL">üöÄ Full-Stack App</button>
          <button class="qp-btn" data-p="Build a Python FastAPI backend with auth, CRUD and Swagger docs">üêç FastAPI Backend</button>
          <button class="qp-btn" data-p="Create a React dashboard with recharts and dark mode">üìä React Dashboard</button>
          <button class="qp-btn" data-p="Write a machine learning pipeline with sklearn and visualizations">ü§ñ ML Pipeline</button>
        </div>
      </div>
    </div>

    <div class="input-area">
      <div class="attachment-strip" id="attachStrip"></div>
      <div class="input-row">
        <button class="attach-btn" id="attachBtn" title="Attach file">
          <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
        </button>
        <input type="file" id="fileInput" multiple accept="*/*" style="display:none">
        <div class="textarea-wrap">
          <textarea id="msgInput" rows="1" placeholder="Ask anything‚Ä¶ (Shift+Enter for new line)" maxlength="50000"></textarea>
        </div>
        <div class="input-right">
          <span class="char-count" id="charCount">0</span>
          <button class="send-btn" id="sendBtn" disabled>
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z"/></svg>
          </button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <div class="modal-head">
      <h3>Settings</h3>
      <button class="modal-x" id="settingsClose">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="sg">
        <label>Temperature</label>
        <div class="range-row">
          <input type="range" id="tempRange" min="0" max="1" step="0.05" value="0.7">
          <span class="range-val" id="tempVal">0.7</span>
        </div>
        <p class="hint">Higher = more creative ¬∑ Lower = more precise</p>
      </div>
      <div class="sg">
        <label>Max Tokens</label>
        <div class="range-row">
          <input type="range" id="tokensRange" min="256" max="8192" step="256" value="2048">
          <span class="range-val" id="tokensVal">2048</span>
        </div>
      </div>
      <div class="sg">
        <label>System Prompt</label>
        <textarea id="sysPrompt" rows="4">You are NexusAI, a powerful AI assistant specialized in software development. You write clean, well-documented code. Always think step by step.</textarea>
      </div>
      <div class="sg tgl-row">
        <label style="margin-bottom:0">Stream Responses</label>
        <label class="toggle">
          <input type="checkbox" id="streamToggle" checked>
          <span class="tgl-sl"></span>
        </label>
      </div>
    </div>
  </div>
</div>

<!-- RENAME MODAL -->
<div class="modal-overlay" id="renameModal">
  <div class="modal sm">
    <div class="modal-head">
      <h3>Rename Chat</h3>
      <button class="modal-x" id="renameClose">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="text" class="rename-input" id="renameInput" placeholder="Chat title‚Ä¶">
      <button class="btn-save" id="renameSave">Save</button>
    </div>
  </div>
</div>

<!-- DELETE MODAL -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal sm">
    <div class="modal-head">
      <h3>Delete Chat</h3>
      <button class="modal-x" id="deleteClose">‚úï</button>
    </div>
    <div class="modal-body">
      <p style="color:var(--text-dim);margin-bottom:16px;font-size:0.9rem">This will permanently delete this conversation.</p>
      <div class="del-row">
        <button class="btn-cancel-m" id="deleteCancel">Cancel</button>
        <button class="btn-danger-m" id="deleteConfirm">Delete</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
// ================================================================
//  NexusAI Chat Engine
//  ‚ñ∫ Replace YOUR_BIGMODEL_API_KEY below with your real key
//  ‚ñ∫ Replace Firebase config if you want auth + cloud history
//    (works without Firebase too ‚Äî uses localStorage as fallback)
// ================================================================

// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BIGMODEL_KEY = "YOUR_BIGMODEL_API_KEY";   // ‚Üê REPLACE THIS
const API_URL      = "https://open.bigmodel.cn/api/paas/v4/chat/completions";

const FIREBASE_CFG = {
  apiKey:            "YOUR_FIREBASE_API_KEY",   // ‚Üê REPLACE (optional)
  authDomain:        "YOUR_PROJECT.firebaseapp.com",
  projectId:         "YOUR_PROJECT_ID",
  storageBucket:     "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId:             "YOUR_APP_ID"
};

// ‚îÄ‚îÄ FIREBASE (optional) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
import { initializeApp }   from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, getDocs, query, orderBy, onSnapshot, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

let fbAuth, fbDb, firebaseOk = false;
try {
  const fbApp = initializeApp(FIREBASE_CFG);
  fbAuth = getAuth(fbApp);
  fbDb   = getFirestore(fbApp);
  firebaseOk = true;
} catch(e) { console.warn("Firebase disabled (demo mode):", e.message); }

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentUser   = null;
let currentChatId = null;
let chatHistory   = [];
let attachedFiles = [];
let isStreaming   = false;
let aborter       = null;
let pendingId     = null;
let modelCfg      = { id:"glm-5", label:"GLM-5", dot:"standard" };
let thinkingMode  = false;
let settings      = { temperature:0.7, maxTokens:2048, stream:true,
                      systemPrompt: document.getElementById('sysPrompt').value };

// localStorage fallback
let localChats = {};
try { localChats = JSON.parse(localStorage.getItem('nexus_chats')||'{}'); } catch{}
const saveLocal = () => { try { localStorage.setItem('nexus_chats', JSON.stringify(localChats)); } catch{} };

// ‚îÄ‚îÄ DOM SHORTCUTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const G = id => document.getElementById(id);
const sidebar      = G('sidebar');
const sidebarOvl   = G('sidebarOverlay');
const chatList     = G('chatList');
const messagesEl   = G('messages');
const msgInput     = G('msgInput');
const sendBtn      = G('sendBtn');
const charCount    = G('charCount');
const attachStrip  = G('attachStrip');

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if (firebaseOk) {
  onAuthStateChanged(fbAuth, u => {
    if (u) {
      currentUser = u;
      G('userName').textContent  = u.displayName || 'User';
      G('userEmail').textContent = u.email || '';
      G('userAvatar').textContent = (u.displayName||u.email||'U')[0].toUpperCase();
      loadChatList();
    } else {
      G('userName').textContent  = 'Demo User';
      G('userEmail').textContent = 'localStorage mode';
      loadChatList();
    }
  });
} else {
  G('userName').textContent  = 'Demo User';
  G('userEmail').textContent = 'localStorage mode';
  loadChatList();
}

// ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
G('menuBtn').addEventListener('click', () => { sidebar.classList.add('open'); sidebarOvl.classList.add('open'); });
G('sidebarCloseBtn').addEventListener('click', closeSidebar);
sidebarOvl.addEventListener('click', closeSidebar);
function closeSidebar() { sidebar.classList.remove('open'); sidebarOvl.classList.remove('open'); }

// ‚îÄ‚îÄ NEW CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
G('newChatBtn').addEventListener('click', newChat);
function newChat() {
  currentChatId = null; chatHistory = []; attachedFiles = [];
  attachStrip.innerHTML = ''; messagesEl.innerHTML = '';
  messagesEl.appendChild(mkWelcome());
  G('chatTitle').textContent = 'New Chat';
  msgInput.value = ''; resizeTA(); syncSend();
  closeSidebar();
  document.querySelectorAll('.chat-item').forEach(e => e.classList.remove('active'));
}

function mkWelcome() {
  const d = document.createElement('div');
  d.className = 'welcome-screen'; d.id = 'welcomeScreen';
  d.innerHTML = `
    <div class="welcome-icon">‚¨°</div>
    <h2>How can I help you build?</h2>
    <p>Ask me anything ‚Äî code, analysis, files, and more.</p>
    <div class="quick-prompts">
      <button class="qp-btn" data-p="Write a full-stack Next.js app with REST API and PostgreSQL">üöÄ Full-Stack App</button>
      <button class="qp-btn" data-p="Build a Python FastAPI backend with auth, CRUD and Swagger docs">üêç FastAPI Backend</button>
      <button class="qp-btn" data-p="Create a React dashboard with recharts and dark mode">üìä React Dashboard</button>
      <button class="qp-btn" data-p="Write a machine learning pipeline with sklearn and visualizations">ü§ñ ML Pipeline</button>
    </div>`;
  d.querySelectorAll('.qp-btn').forEach(b => b.addEventListener('click', () => {
    msgInput.value = b.dataset.p; resizeTA(); syncSend(); sendMessage();
  }));
  return d;
}

// ‚îÄ‚îÄ MODEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
G('modelBtn').addEventListener('click', e => { e.stopPropagation(); G('modelDropdown').classList.toggle('open'); });
document.addEventListener('click', () => G('modelDropdown').classList.remove('open'));
G('modelDropdown').addEventListener('click', e => e.stopPropagation());
document.querySelectorAll('.model-option').forEach(opt => {
  opt.addEventListener('click', () => {
    modelCfg = { id: opt.dataset.id, label: opt.dataset.label, dot: opt.dataset.dot };
    G('modelLabel').textContent = modelCfg.label;
    G('modelDot').className = 'mdot ' + modelCfg.dot;
    document.querySelectorAll('.model-option').forEach(o => o.classList.remove('selected'));
    opt.classList.add('selected');
    G('modelDropdown').classList.remove('open');
  });
});

// ‚îÄ‚îÄ THINKING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
G('thinkBtn').addEventListener('click', () => {
  thinkingMode = !thinkingMode;
  G('thinkBtn').classList.toggle('active', thinkingMode);
  G('thinkBanner').classList.toggle('show', thinkingMode);
});

// ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
G('settingsBtn').addEventListener('click', () => openModal('settingsModal'));
G('settingsClose').addEventListener('click', () => closeModal('settingsModal'));
G('settingsModal').addEventListener('click', e => { if (e.target===G('settingsModal')) closeModal('settingsModal'); });
G('tempRange').addEventListener('input', () => { settings.temperature=parseFloat(G('tempRange').value); G('tempVal').textContent=G('tempRange').value; });
G('tokensRange').addEventListener('input', () => { settings.maxTokens=parseInt(G('tokensRange').value); G('tokensVal').textContent=G('tokensRange').value; });
G('streamToggle').addEventListener('change', e => { settings.stream=e.target.checked; });
G('sysPrompt').addEventListener('input', e => { settings.systemPrompt=e.target.value; });

// ‚îÄ‚îÄ RENAME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
G('editTitleBtn').addEventListener('click', () => {
  if (!currentChatId) return;
  G('renameInput').value = G('chatTitle').textContent;
  pendingId = currentChatId; openModal('renameModal');
  setTimeout(() => G('renameInput').focus(), 80);
});
G('renameClose').addEventListener('click', () => closeModal('renameModal'));
G('renameModal').addEventListener('click', e => { if (e.target===G('renameModal')) closeModal('renameModal'); });
G('renameSave').addEventListener('click', async () => {
  const t = G('renameInput').value.trim() || 'Untitled';
  if (pendingId) {
    if (currentUser && firebaseOk) await updateDoc(doc(fbDb,'users',currentUser.uid,'chats',pendingId), {title:t});
    else if (localChats[pendingId]) { localChats[pendingId].title=t; saveLocal(); renderLocalList(); }
    if (pendingId === currentChatId) G('chatTitle').textContent = t;
  }
  closeModal('renameModal');
});

// ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
G('deleteClose').addEventListener('click', () => closeModal('deleteModal'));
G('deleteCancel').addEventListener('click', () => closeModal('deleteModal'));
G('deleteModal').addEventListener('click', e => { if (e.target===G('deleteModal')) closeModal('deleteModal'); });
G('deleteConfirm').addEventListener('click', async () => {
  if (pendingId) {
    if (currentUser && firebaseOk) await deleteDoc(doc(fbDb,'users',currentUser.uid,'chats',pendingId));
    else { delete localChats[pendingId]; saveLocal(); renderLocalList(); }
    if (pendingId === currentChatId) newChat();
  }
  closeModal('deleteModal');
});
G('deleteAllBtn').addEventListener('click', async () => {
  if (!confirm('Delete ALL chats? Cannot be undone.')) return;
  if (currentUser && firebaseOk) {
    const snap = await getDocs(collection(fbDb,'users',currentUser.uid,'chats'));
    const b = writeBatch(fbDb); snap.forEach(d => b.delete(d.ref)); await b.commit();
  } else { localChats={}; saveLocal(); chatList.innerHTML=''; }
  newChat();
});

// ‚îÄ‚îÄ LOGOUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
G('logoutBtn').addEventListener('click', async () => {
  if (firebaseOk && fbAuth) await signOut(fbAuth);
  window.location.href = 'login.html';
});

// ‚îÄ‚îÄ CHAT LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadChatList() {
  if (currentUser && firebaseOk) {
    const q = query(collection(fbDb,'users',currentUser.uid,'chats'), orderBy('updatedAt','desc'));
    onSnapshot(q, snap => { chatList.innerHTML=''; snap.forEach(d => renderChatItem(d.id, d.data())); });
  } else {
    renderLocalList();
  }
}
function renderLocalList() {
  chatList.innerHTML = '';
  Object.entries(localChats).sort((a,b)=>(b[1].updatedAt||0)-(a[1].updatedAt||0)).forEach(([id,d])=>renderChatItem(id,d));
}
function renderChatItem(id, data) {
  const el = document.createElement('div');
  el.className = 'chat-item' + (id===currentChatId?' active':'');
  el.dataset.id = id;
  el.innerHTML = `<span style="color:var(--text-muted);font-size:.78rem;flex-shrink:0">‚ó∑</span>
    <span class="chat-item-text">${esc(data.title||'Untitled')}</span>
    <div class="chat-item-actions">
      <button class="chat-action-btn" title="Rename">‚úé</button>
      <button class="chat-action-btn del" title="Delete">üóë</button>
    </div>`;
  el.addEventListener('click', e => { if (!e.target.closest('.chat-action-btn')) loadChat(id, data); });
  el.querySelectorAll('.chat-action-btn')[0].addEventListener('click', () => {
    G('renameInput').value = data.title||''; pendingId=id; openModal('renameModal'); setTimeout(()=>G('renameInput').focus(),80);
  });
  el.querySelectorAll('.chat-action-btn')[1].addEventListener('click', () => { pendingId=id; openModal('deleteModal'); });
  chatList.appendChild(el);
}
async function loadChat(id, data) {
  currentChatId = id;
  G('chatTitle').textContent = data.title || 'Chat';
  document.querySelectorAll('.chat-item').forEach(el => el.classList.toggle('active', el.dataset.id===id));
  closeSidebar(); messagesEl.innerHTML=''; chatHistory=[];
  if (currentUser && firebaseOk) {
    const q = query(collection(fbDb,'users',currentUser.uid,'chats',id,'messages'), orderBy('createdAt','asc'));
    const snap = await getDocs(q);
    snap.forEach(d => { const m=d.data(); chatHistory.push(m); renderMsg(m); });
  } else {
    (localChats[id]?.messages||[]).forEach(m => { chatHistory.push(m); renderMsg(m); });
  }
  scrollBottom();
}

// ‚îÄ‚îÄ FILE HANDLING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
G('attachBtn').addEventListener('click', () => G('fileInput').click());
G('fileInput').addEventListener('change', async () => {
  for (const f of Array.from(G('fileInput').files)) await processFile(f);
  G('fileInput').value=''; syncSend();
});
msgInput.addEventListener('dragover', e => { e.preventDefault(); msgInput.style.borderColor='var(--accent)'; });
msgInput.addEventListener('dragleave', () => { msgInput.style.borderColor=''; });
msgInput.addEventListener('drop', async e => {
  e.preventDefault(); msgInput.style.borderColor='';
  for (const f of Array.from(e.dataTransfer.files)) await processFile(f);
  syncSend();
});
async function processFile(file) {
  if (file.size > 20*1024*1024) { alert(`"${file.name}" exceeds 20MB`); return; }
  const e = { name:file.name, type:file.type, size:file.size };
  const textish = ['text/','application/json','application/javascript','application/typescript'].some(t=>file.type.startsWith(t))
    || /\.(js|ts|jsx|tsx|py|go|rs|rb|php|cs|java|cpp|c|h|html|css|json|md|txt|yaml|yml|sh|env|toml)$/i.test(file.name);
  if (file.type.startsWith('image/')) {
    e.base64=await toB64(file); e.kind='image';
  } else if (textish) {
    e.text=await file.text(); e.kind='text';
  } else if (/\.zip$/i.test(file.name) && typeof JSZip!=='undefined') {
    try {
      const zip=await JSZip.loadAsync(file); let out=`[ZIP: ${file.name}]\n\n`;
      for (const [p,ze] of Object.entries(zip.files)) { if (!ze.dir) { try { out+=`--- ${p} ---\n${await ze.async('text')}\n\n`; } catch{out+=`--- ${p} (binary)\n\n`;} } }
      e.text=out; e.kind='zip';
    } catch { e.base64=await toB64(file); e.kind='binary'; }
  } else { e.base64=await toB64(file); e.kind='binary'; }
  attachedFiles.push(e);
  renderAttChip(e);
}
const toB64 = f => new Promise((res,rej) => { const r=new FileReader(); r.onload=()=>res(r.result.split(',')[1]); r.onerror=rej; r.readAsDataURL(f); });
function renderAttChip(e) {
  const c=document.createElement('div'); c.className='att-chip'; c.dataset.name=e.name;
  c.innerHTML = e.kind==='image'
    ? `<img class="att-chip-img" src="data:${e.type};base64,${e.base64}"><span>${esc(e.name)}</span><button class="att-chip-del">√ó</button>`
    : `<span>${fIcon(e.name)} ${esc(e.name)}</span><button class="att-chip-del">√ó</button>`;
  c.querySelector('.att-chip-del').addEventListener('click', () => { attachedFiles=attachedFiles.filter(f=>f.name!==e.name); c.remove(); syncSend(); });
  attachStrip.appendChild(c);
}
const fIcon = n => ({js:'üü®',ts:'üî∑',jsx:'‚öõÔ∏è',tsx:'‚öõÔ∏è',py:'üêç',html:'üåê',css:'üé®',json:'üìã',md:'üìù',zip:'üì¶',pdf:'üìï',png:'üñº',jpg:'üñº',svg:'üé®',sh:'üìú',go:'üêπ',rs:'‚öôÔ∏è'}[(n.split('.').pop()||'').toLowerCase()]||'üìÑ');

// ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
sendBtn.addEventListener('click', () => { if (!sendBtn.disabled) sendMessage(); });
msgInput.addEventListener('input', () => { resizeTA(); syncSend(); charCount.textContent = msgInput.value.length; });
msgInput.addEventListener('keydown', e => { if (e.key==='Enter'&&!e.shiftKey) { e.preventDefault(); if (!sendBtn.disabled) sendMessage(); } });
function resizeTA() {
  msgInput.style.height='auto';
  const h=Math.min(msgInput.scrollHeight,180);
  msgInput.style.height=h+'px';
  msgInput.style.overflowY=msgInput.scrollHeight>180?'auto':'hidden';
}
function syncSend() { sendBtn.disabled = isStreaming || (msgInput.value.trim()===''&&attachedFiles.length===0); }

// ‚îÄ‚îÄ SEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sendMessage() {
  const text = msgInput.value.trim();
  if (isStreaming || (text===''&&attachedFiles.length===0)) return;

  const userMsg = { role:'user', content:text, files:[...attachedFiles] };
  chatHistory.push(userMsg);
  renderMsg(userMsg);
  scrollBottom();

  msgInput.value=''; resizeTA();
  attachedFiles=[]; attachStrip.innerHTML=''; syncSend();
  document.getElementById('welcomeScreen')?.remove();

  const typing = showTyping();
  isStreaming=true; syncSend(); showStop();

  if (!currentChatId) {
    const title = text ? text.slice(0,46)+(text.length>46?'‚Ä¶':'') : (userMsg.files[0]?.name||'New Chat');
    if (currentUser && firebaseOk) {
      const ref = await addDoc(collection(fbDb,'users',currentUser.uid,'chats'), { title, createdAt:serverTimestamp(), updatedAt:serverTimestamp(), model:modelCfg.id });
      currentChatId = ref.id;
    } else {
      currentChatId = 'lc_'+Date.now();
      localChats[currentChatId] = { title, updatedAt:Date.now(), messages:[] };
      saveLocal(); renderLocalList();
    }
    G('chatTitle').textContent = title;
  }

  await saveMsg(userMsg);

  try {
    const res = await callAPI();
    typing.remove();
    const aiMsg = { role:'assistant', content:res.content, thinking:res.thinking||'' };
    chatHistory.push(aiMsg);
    renderMsg(aiMsg);
    scrollBottom();
    await saveMsg(aiMsg);
    if (currentUser && firebaseOk) await updateDoc(doc(fbDb,'users',currentUser.uid,'chats',currentChatId), {updatedAt:serverTimestamp()});
    else if (localChats[currentChatId]) { localChats[currentChatId].updatedAt=Date.now(); saveLocal(); }
  } catch(err) {
    typing.remove();
    if (err.name!=='AbortError') showError(err.message||'API error. Check your key and connection.');
  } finally { isStreaming=false; aborter=null; syncSend(); hideStop(); }
}

// ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function callAPI() {
  aborter = new AbortController();
  const msgs = [];
  if (settings.systemPrompt) msgs.push({ role:'system', content:settings.systemPrompt });

  for (const m of chatHistory) {
    if (m.role==='user') {
      const parts=[];
      if (m.content) parts.push({ type:'text', text:m.content });
      (m.files||[]).forEach(f => {
        if (f.kind==='image') parts.push({ type:'image_url', image_url:{ url:`data:${f.type};base64,${f.base64}` } });
        else if (f.text) parts.push({ type:'text', text:`\n\n[File: ${f.name}]\n\`\`\`\n${f.text}\n\`\`\`` });
        else if (f.base64) parts.push({ type:'text', text:`[Binary file: ${f.name}]` });
      });
      msgs.push({ role:'user', content: parts.length===1&&parts[0].type==='text' ? parts[0].text : parts });
    } else {
      msgs.push({ role:'assistant', content: m.content||'' });
    }
  }

  const body = { model:modelCfg.id, messages:msgs, temperature:settings.temperature, max_tokens:settings.maxTokens, stream:settings.stream };
  const res = await fetch(API_URL, {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${BIGMODEL_KEY}` },
    body:JSON.stringify(body),
    signal:aborter.signal
  });

  if (!res.ok) {
    let em = `API error ${res.status}`; try { const j=await res.json(); em=j?.error?.message||em; } catch{}
    throw new Error(em);
  }

  if (!settings.stream) {
    const d = await res.json();
    return { content:d.choices?.[0]?.message?.content||'', thinking:d.choices?.[0]?.message?.reasoning_content||'' };
  }

  const aiEl = mkStreamEl();
  let full='', thinking='';
  const reader=res.body.getReader(); const dec=new TextDecoder(); let buf='';
  while (true) {
    const {done,value} = await reader.read(); if (done) break;
    buf += dec.decode(value,{stream:true});
    const lines=buf.split('\n'); buf=lines.pop();
    for (const line of lines) {
      if (!line.startsWith('data: ')) continue;
      const raw=line.slice(6).trim(); if (raw==='[DONE]') continue;
      try {
        const j=JSON.parse(raw); const d=j.choices?.[0]?.delta;
        if (d?.reasoning_content) thinking+=d.reasoning_content;
        if (d?.content) { full+=d.content; updateStreamEl(aiEl, full, thinking); }
      } catch{}
    }
  }
  finalizeStreamEl(aiEl, full, thinking);
  return { content:full, thinking };
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMsg(m) {
  const isUser = m.role==='user';
  const el = document.createElement('div');
  el.className = `message ${isUser?'user':'ai'}`;
  const av = (currentUser?.displayName||currentUser?.email||'U')[0].toUpperCase();

  if (isUser) {
    let fHtml='';
    (m.files||[]).forEach(f => {
      fHtml += f.kind==='image'
        ? `<img src="data:${f.type};base64,${f.base64}" style="max-width:200px;max-height:180px;border-radius:8px;margin-top:7px;display:block">`
        : `<div class="att-chip" style="margin-top:5px;display:inline-flex">${fIcon(f.name)} ${esc(f.name)}</div>`;
    });
    el.innerHTML = `<div class="msg-avatar">${av}</div><div class="msg-content"><div class="msg-bubble">${m.content?esc(m.content).replace(/\n/g,'<br>'):''}${fHtml}</div></div>`;
  } else {
    const tHtml = m.thinking ? mkThinkBlock(m.thinking) : '';
    const cHtml = renderMd(m.content||'');
    const dlHtml = mkDlChips(m.content||'');
    el.innerHTML = `<div class="msg-avatar">‚¨°</div><div class="msg-content">${tHtml}<div class="msg-bubble">${cHtml}</div>${dlHtml}<div class="msg-actions"><button class="msg-act-btn copy-btn">Copy</button></div></div>`;
    el.querySelector('.copy-btn').addEventListener('click', () => copyText(m.content||''));
    attachThinkToggles(el);
    attachCodeBtns(el);
    attachDlBtns(el, m.content||'');
    setTimeout(() => el.querySelectorAll('pre code').forEach(b => { if (!b.dataset.hl) { hljs.highlightElement(b); b.dataset.hl='1'; } }), 10);
  }
  messagesEl.appendChild(el); return el;
}

function mkStreamEl() {
  const el=document.createElement('div'); el.className='message ai';
  // sb = raw text container during stream; rendered = final markdown container
  el.innerHTML=`<div class="msg-avatar">‚¨°</div><div class="msg-content"><div class="msg-bubble sb" style="white-space:pre-wrap;word-break:break-word"></div></div>`;
  messagesEl.appendChild(el); scrollBottom(); return el;
}

// RAF batching for smooth streaming ‚Äî no markdown parse during stream
let _rafPending = false;
let _pendingContent = '';
let _pendingEl = null;
function updateStreamEl(el, content, thinking) {
  // Handle thinking block (rare, low freq updates)
  let tb=el.querySelector('.thinking-block');
  if (thinking && !tb) {
    const d=document.createElement('div'); d.innerHTML=mkThinkBlock(thinking);
    el.querySelector('.msg-content').insertBefore(d.firstChild, el.querySelector('.sb'));
    attachThinkToggles(el);
  } else if (thinking && tb) {
    const tc=tb.querySelector('.thinking-content'); if(tc) tc.textContent=thinking;
  }
  // Batch text updates via RAF to avoid per-token repaints
  _pendingContent = content;
  _pendingEl = el;
  if (!_rafPending) {
    _rafPending = true;
    requestAnimationFrame(() => {
      _rafPending = false;
      const sb = _pendingEl?.querySelector('.sb');
      if (sb) {
        // During streaming: plain text display (no flicker, no heavy parsing)
        sb.textContent = _pendingContent;
        // Auto-scroll only if near bottom
        const atBottom = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight < 120;
        if (atBottom) messagesEl.scrollTop = messagesEl.scrollHeight;
      }
    });
  }
}

function finalizeStreamEl(el, content, thinking) {
  // Now that stream is done: replace plain text with full rendered markdown
  const sb=el.querySelector('.sb');
  if (sb) {
    sb.style.whiteSpace='';
    sb.style.wordBreak='';
    sb.innerHTML = renderMd(content);
    sb.classList.remove('sb');
  }
  // Highlight all code blocks once
  el.querySelectorAll('pre code').forEach(b=>{ if(!b.dataset.hl){hljs.highlightElement(b);b.dataset.hl='1';} });
  attachCodeBtns(el);
  const dlHtml=mkDlChips(content);
  if (dlHtml) {
    const d=document.createElement('div'); d.innerHTML=dlHtml;
    el.querySelector('.msg-content').appendChild(d.firstChild);
    attachDlBtns(el.querySelector('.file-downloads'), content);
  }
  const acts=document.createElement('div'); acts.className='msg-actions';
  acts.innerHTML='<button class="msg-act-btn copy-btn">Copy</button>';
  acts.querySelector('.copy-btn').addEventListener('click',()=>copyText(content));
  el.querySelector('.msg-content').appendChild(acts);
  scrollBottom();
}

function mkThinkBlock(txt) {
  const id='th_'+Math.random().toString(36).slice(2);
  return `<div class="thinking-block"><button class="thinking-toggle" data-tid="${id}"><span class="think-arrow">‚ñ∂</span> ‚óé Thinking<span style="margin-left:auto;font-size:.68rem;color:var(--text-muted)">${txt.split('\n').length} lines</span></button><div class="thinking-content" id="${id}">${esc(txt)}</div></div>`;
}
function attachThinkToggles(container) {
  container.querySelectorAll('.thinking-toggle').forEach(btn => {
    if (btn.dataset.bound) return; btn.dataset.bound='1';
    btn.addEventListener('click', () => {
      const c=document.getElementById(btn.dataset.tid); if(!c) return;
      c.classList.toggle('open');
      btn.querySelector('.think-arrow')?.classList.toggle('open');
    });
  });
}

function renderMd(text) {
  if (!text) return '';
  if (typeof marked==='undefined') return `<p>${esc(text).replace(/\n/g,'<br>')}</p>`;
  marked.setOptions({ gfm:true, breaks:true });
  let html = marked.parse(text);
  html = html.replace(/<pre><code(?: class="language-(\w+)")?>/g, (_,lang) => {
    const l=lang||'code';
    return `<div class="code-wrapper"><div class="code-header"><span class="code-lang-label">${l}</span><div class="code-actions-row"><button class="code-btn copy-code-btn">Copy</button><button class="code-btn dl-code-btn" data-lang="${l}">‚Üì Save</button></div></div><pre><code class="${lang?`language-${lang}`:''}">`;
  });
  return html.replace(/<\/code><\/pre>/g,'</code></pre></div>');
}
function attachCodeBtns(container) {
  container.querySelectorAll('.copy-code-btn').forEach(btn => {
    if (btn.dataset.b) return; btn.dataset.b='1';
    btn.addEventListener('click', () => {
      const code=btn.closest('.code-wrapper')?.querySelector('code')?.textContent||'';
      copyText(code); btn.textContent='‚úì Copied'; btn.classList.add('ok');
      setTimeout(()=>{ btn.textContent='Copy'; btn.classList.remove('ok'); },2000);
    });
  });
  container.querySelectorAll('.dl-code-btn').forEach(btn => {
    if (btn.dataset.b) return; btn.dataset.b='1';
    btn.addEventListener('click', () => {
      const code=btn.closest('.code-wrapper')?.querySelector('code')?.textContent||'';
      const ext={javascript:'js',typescript:'ts',python:'py',bash:'sh',html:'html',css:'css',json:'json',rust:'rs',go:'go',java:'java',jsx:'jsx',tsx:'tsx',markdown:'md'}[btn.dataset.lang]||btn.dataset.lang||'txt';
      dlFile(code,`code.${ext}`,'text/plain');
    });
  });
}
function mkDlChips(content) {
  const blocks=[]; const re=/```(\w+)\n([\s\S]*?)```/g; let m;
  while((m=re.exec(content))!==null) blocks.push({lang:m[1],code:m[2]});
  if (blocks.length<2) return '';
  return `<div class="file-downloads"><button class="file-dl-btn zdl">üì¶ Download project.zip (${blocks.length} files)</button></div>`;
}
function attachDlBtns(container, content) {
  container?.querySelectorAll('.zdl').forEach(btn => {
    if (btn.dataset.b) return; btn.dataset.b='1';
    btn.addEventListener('click', async () => {
      if (typeof JSZip==='undefined') { alert('JSZip not available'); return; }
      const blocks=[]; const re=/```(\w+)\n([\s\S]*?)```/g; let m;
      while((m=re.exec(content))!==null) blocks.push({lang:m[1],code:m[2]});
      const zip=new JSZip();
      const extM={javascript:'js',typescript:'ts',python:'py',bash:'sh',html:'html',css:'css',json:'json',jsx:'jsx',tsx:'tsx',rust:'rs',go:'go',markdown:'md'};
      blocks.forEach((b,i)=>zip.file(`file${i+1}.${extM[b.lang]||b.lang||'txt'}`,b.code));
      dlBlob(await zip.generateAsync({type:'blob'}),'project.zip');
    });
  });
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showTyping() {
  const el=document.createElement('div'); el.className='message ai';
  el.innerHTML=`<div class="msg-avatar">‚¨°</div><div class="msg-content"><div class="typing-dots"><span></span><span></span><span></span></div></div>`;
  messagesEl.appendChild(el); scrollBottom(); return el;
}
function showStop() {
  sendBtn.style.display='none';
  const s=document.createElement('button'); s.className='stop-btn'; s.id='stopBtn'; s.textContent='‚èπ';
  s.addEventListener('click',()=>aborter?.abort());
  sendBtn.parentNode.insertBefore(s,sendBtn);
}
function hideStop() { document.getElementById('stopBtn')?.remove(); sendBtn.style.display=''; }
function showError(msg) {
  const el=document.createElement('div'); el.className='message ai';
  el.innerHTML=`<div class="msg-avatar">‚¨°</div><div class="msg-content"><div class="error-bubble">‚ö†Ô∏è ${esc(msg)}</div></div>`;
  messagesEl.appendChild(el); scrollBottom();
}
function scrollBottom() { messagesEl.scrollTop=messagesEl.scrollHeight; }
function esc(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
function copyText(t) { navigator.clipboard.writeText(t).catch(()=>{ const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }); }
function dlFile(content,name,mime) { dlBlob(new Blob([content],{type:mime}),name); }
function dlBlob(blob,name) { const u=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=u; a.download=name; a.click(); URL.revokeObjectURL(u); }
function openModal(id) { document.getElementById(id)?.classList.add('open'); }
function closeModal(id) { document.getElementById(id)?.classList.remove('open'); }
async function saveMsg(msg) {
  if (!currentChatId) return;
  const data={ role:msg.role, content:msg.content||'' };
  if (msg.thinking) data.thinking=msg.thinking;
  if (msg.files?.length) data.files=msg.files.map(f=>({name:f.name,type:f.type,kind:f.kind,size:f.size}));
  if (currentUser && firebaseOk) {
    await addDoc(collection(fbDb,'users',currentUser.uid,'chats',currentChatId,'messages'),{...data,createdAt:serverTimestamp()});
  } else if (localChats[currentChatId]) {
    if (!localChats[currentChatId].messages) localChats[currentChatId].messages=[];
    localChats[currentChatId].messages.push({...data,createdAt:Date.now()});
    saveLocal();
  }
}

// Wire up static quick prompt buttons
document.querySelectorAll('#welcomeScreen .qp-btn').forEach(b => {
  b.addEventListener('click', () => { msgInput.value=b.dataset.p; resizeTA(); syncSend(); sendMessage(); });
});
</script>
</body>
</html>
